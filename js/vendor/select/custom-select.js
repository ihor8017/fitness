import{createElement,renderElement}from"./utils.js";import{createNativeSelectMarkup}from"./create-select-markup.js";export class CustomSelect{constructor(){this._selects=null,this._selectElement=null,this._activeIndex=null,this._onDocumentClick=this._onDocumentClick.bind(this),this._onEscapePress=this._onEscapePress.bind(this),this._onSelectItemClick=this._onSelectItemClick.bind(this),this._onSelectItemKeydown=this._onSelectItemKeydown.bind(this),this._onLastItemKeydown=this._onLastItemKeydown.bind(this),this._onSelectClick=this._onSelectClick.bind(this),this._onSelectKeydown=this._onSelectKeydown.bind(this),window.selectInit=this.init.bind(this)}_createMultiString(e){let t="";return e.length&&(1===e.length?t=e[0].innerHTML:e.forEach(((s,i)=>{i===e.length-1?t+=s.innerHTML:t+=`${s.innerHTML}, `}))),t}_setSelectActiveState(e,t,s){const i=s.querySelector(".custom-select__text"),c=s.querySelectorAll('.custom-select__item[aria-selected="true"]'),l=s.querySelector(".custom-select__label"),n=this._createMultiString(c);if(i.style.transition="0s",l&&(l.style.transition="0s"),setTimeout((()=>{l&&(l.style.transition=null),i.style.transition=null}),300),e&&t)s.classList.add("not-empty"),i.innerHTML=n;else{if(e)return;s.classList.add("not-empty"),i.innerHTML=c[0].innerHTML}}_closeSelect(){const e=document.querySelector("[data-select].is-open");document.removeEventListener("click",this._onDocumentClick),document.removeEventListener("keydown",this._onEscapePress),e&&e.classList.remove("is-open")}_onSelectElementClickAction(e,t){const s=e.closest(".custom-select"),i=s.dataset.multiple,c=s.dataset.insert,l=s.querySelector(".custom-select__text"),n=e.textContent,o=s.querySelectorAll("option"),r=s.querySelector("select"),a=new CustomEvent("change"),d=new CustomEvent("input");r.dispatchEvent(a),r.dispatchEvent(d);const u=r.closest("form"),m=s.querySelector(".input-message");if(m&&m.remove(),u){const e=new CustomEvent("change"),t=new CustomEvent("input");u.dispatchEvent(e),u.dispatchEvent(t)}if(i)if("true"===c)if("true"===e.getAttribute("aria-selected")){e.setAttribute("aria-selected","false");const i=s.querySelectorAll('.custom-select__item[aria-selected="true"]'),c=this._createMultiString(i);o[t+1].selected=!1,l.innerText=c,c||(s.classList.remove("not-empty"),s.classList.remove("is-valid"))}else{e.setAttribute("aria-selected","true");const i=s.querySelectorAll('.custom-select__item[aria-selected="true"]'),c=this._createMultiString(i);l.innerText=c,s.classList.add("not-empty"),s.classList.add("is-valid"),o[t+1].selected=!0}else"true"===e.getAttribute("aria-selected")?(e.setAttribute("aria-selected","false"),o[t+1].selected=!1):(e.setAttribute("aria-selected","true"),o[t+1].selected=!0);else{const i=s.querySelector('.custom-select__item[aria-selected="true"]');"true"===e.getAttribute("aria-selected")||(i&&(i.setAttribute("aria-selected","false"),s.classList.remove("not-empty"),s.classList.remove("is-valid")),l.innerText=n,e.setAttribute("aria-selected","true"),s.classList.add("not-empty"),s.classList.add("is-valid"),o[t+1].selected=!0),this._closeSelect()}}_onDocumentClick({target:e}){e.closest(".custom-select")||this._closeSelect()}_onEscapePress(e){"Escape"===e.key&&this._closeSelect()}_onSelectItemClick(e,t){this._onSelectElementClickAction(e,t)}_onSelectItemKeydown(e,t,s){"Enter"===e.key&&this._onSelectElementClickAction(t,s)}_onLastItemKeydown(e){"Tab"===e.key&&this._closeSelect()}_onSelectClick(e){const t=e.target.closest("[data-select]"),s=document.querySelector("[data-select].is-open");t.classList.remove("is-invalid"),s&&s===t?s.classList.remove("is-open"):(s&&this._closeSelect(),document.addEventListener("click",this._onDocumentClick),document.addEventListener("keydown",this._onEscapePress),t.classList.contains("is-open")?t.classList.remove("is-open"):t.classList.add("is-open"))}_onSelectKeydown(e){const t=e.target.closest("[data-select]");t.classList.remove("is-invalid"),e.shiftKey&&"Tab"===e.key&&t.closest(".is-open")&&this._closeSelect()}_setActiveSelectItemsState(e,t){let s=!0;this._activeIndex=[],t.forEach(((t,i)=>{e?"true"===t.getAttribute("aria-selected")&&this._activeIndex.push(i):"true"===t.getAttribute("aria-selected")&&s?(this._activeIndex.push(i),s=!1):t.setAttribute("aria-selected","false")}))}_createSelectStructure(e){if(e.querySelector("select"))return void(this._selectElement=null);const t={items:[]},s=e.dataset.multiple,i=e.dataset.id,c=e.dataset.name,l=e.dataset.required,n=e.dataset.insert,o=e.querySelectorAll(".custom-select__item");this._setActiveSelectItemsState(s,o),this._activeIndex.length&&(t.activeIndex=this._activeIndex,this._setSelectActiveState(s,n,e)),t.name=c||!1,t.id=i||!1,t.required=Boolean(l),t.multiple=Boolean(s),o.forEach((e=>{const s=e.dataset.selectValue,i={};i.text=e.textContent,i.value=s,t.items.push(i)})),renderElement(e,createElement(createNativeSelectMarkup(t))),this._selectElement=e,this._activeIndex=null}_setSelectAction(){if(!this._selectElement)return;const e=this._selectElement.querySelector(".custom-select__button"),t=this._selectElement.querySelectorAll(".custom-select__item");e.addEventListener("click",this._onSelectClick),e.addEventListener("keydown",this._onSelectKeydown),t.forEach(((e,s)=>{e.addEventListener("click",(()=>{this._onSelectItemClick(e,s)})),e.addEventListener("keydown",(t=>{this._onSelectItemKeydown(t,e,s)})),s===t.length-1&&e.addEventListener("keydown",this._onLastItemKeydown)}))}init(){this._selects=document.querySelectorAll("[data-select]"),this._selects.forEach((e=>{this._createSelectStructure(e),this._setSelectAction()}))}}