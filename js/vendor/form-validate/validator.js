import{getLimitationsRegEx,getMatrixLimitationsRegEx,getMailRegEx}from"./regular-expression.js";import{matrixReplace}from"./matrix.js";import{Message}from"./render-message.js";export class Validator{constructor(){this._getLimitationsRegEx=getLimitationsRegEx,this._getMatrixLimitationsRegEx=getMatrixLimitationsRegEx,this._getMailRegEx=getMailRegEx,this._matrixReplace=matrixReplace,this._message=new Message,this._invalidNotEmpty=!1,this._validState=!0,this._submitEvent=!1}_createStates(t){this._validState=!0,this._invalidNotEmpty=!1;const e=t.closest("[data-form-validate]");e.querySelectorAll("input","select","textarea").forEach((t=>{"true"===t.getAttribute("aria-invalid")&&(this._validState=!1,t.value&&(this._invalidNotEmpty=!0))})),this._validateFormParent(e)}_renderMessage(t,e,a){(e.hasAttribute("data-required")||a.value)&&(t?e.hasAttribute("data-message-success")?this._message.renderMessage(e,e.dataset.messageSuccess,"valid"):this._message.removeMessage(e):(e.classList.add("is-invalid"),e.hasAttribute("data-message-base")&&!a.value?this._message.renderMessage(e,e.dataset.messageBase,"invalid"):e.hasAttribute("data-message-extra")&&a.value?this._message.renderMessage(e,e.dataset.messageExtra,"invalid"):!e.hasAttribute("data-message-extra")&&e.hasAttribute("data-message-base")&&a.value?this._message.renderMessage(e,e.dataset.messageBase,"invalid"):this._message.removeMessage(e)))}_setItemValidState(t,e){(t.hasAttribute("data-required")||e.value)&&(t.classList.add("is-valid"),t.classList.remove("is-invalid"),e.setAttribute("aria-invalid","false"),this._message.removeMessage(t))}_setItemInvalidState(t,e){(t.hasAttribute("data-required")||e.value)&&(t.classList.remove("is-valid"),e.setAttribute("aria-invalid","true"))}_simpleLimitation(t,e){t.value=t.value.replace(this._getLimitationsRegEx(e),"")}_matrixLimitation(t,e,a){this._matrixReplace(t,e,a)}_validateTextInput(t,e){let a=!0;return e.value.length>=(+e.getAttribute("minlength")||1)?this._setItemValidState(t,e):(this._setItemInvalidState(t,e),a=!1),a}_validateMatrixInput(t,e){let a=!0;return e.value.length===e.closest("[data-matrix]").dataset.matrix.length?this._setItemValidState(t,e):(this._setItemInvalidState(t,e),a=!1),a}_validateEmailInput(t,e){let a=!0;return new RegExp(this._getMailRegEx(),"").test(e.value)?this._setItemValidState(t,e):(this._setItemInvalidState(t,e),a=!1),a}_validatePhoneInput(t,e){let a=!0;return e.value.length>=+t.dataset.phoneLength?this._setItemValidState(t,e):(this._setItemInvalidState(t,e),a=!1),a}_validateCheckbox(t,e){let a=!0;return e.checked?this._setItemValidState(t,e):(this._setItemInvalidState(t,e),a=!1),a}_findSelectedOption(t){let e=!1;return t.forEach((t=>{t.value&&t.selected&&(e=!0)})),e}_validateSelect(t,e){const a=e.querySelectorAll("option"),i=t.querySelector(".custom-select__text");e.setAttribute("aria-invalid","false");let s=!0;return this._findSelectedOption(a)?this._setItemValidState(t,e):(this._setItemInvalidState(t,e),t.classList.remove("not-empty"),i.innerHTML="",s=!1),s}_returnCheckedElements(t){let e=!1;return t.forEach((t=>{t.checked&&(e=!0)})),e}_removeGroupAria(t){t.forEach((t=>{t.checked?(t.setAttribute("aria-required",!0),t.setAttribute("aria-invalid",!1)):(t.removeAttribute("aria-required"),t.removeAttribute("aria-invalid"))}))}_setGroupAria(t){t.forEach((t=>{t.setAttribute("aria-required",!0),t.setAttribute("aria-invalid",!0)}))}_validateToggleGroup(t){const e=t.querySelectorAll("input");let a=!0;return this._returnCheckedElements(e)?(this._removeGroupAria(e),t.classList.remove("is-invalid"),t.classList.add("is-valid"),this._message.removeMessage(t)):(this._setGroupAria(e),t.classList.remove("is-valid"),a=!1),a}_customExample(t,e){let a=!0;return e.value.length?e.value.length<e.minLength?(t.dataset.messageBase=`Осталось ввести ещё ${e.minLength-e.value.length} символов`,this._setItemInvalidState(t,e),a=!1):e.value.length>e.minLength?(t.dataset.messageBase=`Вы ввели ${e.value.length-e.minLength} лишних символов`,this._setItemInvalidState(t,e),a=!1):(t.dataset.messageSuccess="Поле заполнено корректно",this._setItemValidState(t,e),a=!0):(t.dataset.messageBase="Поле обязательно к заполнению",this._setItemInvalidState(t,e),a=!1),a}_validateFile(t,e){let a=!0;const i=!t.dataset.maxSize||!e.files[0]||e.files[0].size<+t.dataset.maxSize;return e.value&&i?this._setItemValidState(t,e):(this._setItemInvalidState(t,e),a=!1),a}_customUpload(t,e){let a=!0;return!t.classList.contains("is-invalid")&&e.files[0]||(a=!1),a}_validateInput(t,e,a){switch(t){case"text":return this._validateTextInput(e,a);case"matrix":return this._validateMatrixInput(e,a);case"email":return this._validateEmailInput(e,a);case"phone":return this._validatePhoneInput(e,a);case"checkbox":return this._validateCheckbox(e,a);case"select":return this._validateSelect(e,a);case"toggle-group":return this._validateToggleGroup(e,a);case"file":return this._validateFile(e,a);case"custom-upload":return this._customUpload(e,a);case"custom-example":return this._customExample(e,a);default:return!1}}_baseParentValidate(t){this._submitEvent&&(this._invalidNotEmpty||this._validState?!this._invalidNotEmpty||this._validState?this._validState&&this._message.removeMessage(t):this._message.renderMessage(t,t.dataset.messageExtra||t.dataset.messageBase,"invalid"):this._message.renderMessage(t,t.dataset.messageBase,"invalid"))}_validateParent(t,e){return"base"===e&&this._baseParentValidate(t)}validateFormElement(t,e=!1){const a=t.closest("[data-validate-type]");if(!a)return;if(!a.hasAttribute("data-required")){(a.querySelector("input")||a.querySelector("select")||a.querySelector("textarea")).value||(a.classList.remove("is-valid"),a.classList.remove("is-invalid"))}const i=a.hasAttribute("data-on-input-validate");a.hasAttribute("data-limitation")&&this._simpleLimitation(t,a.dataset.limitation),"matrix"===a.dataset.validateType&&this._matrixLimitation(t,a.dataset.matrix,this._getMatrixLimitationsRegEx(a.dataset.matrixLimitation));const s=this._validateInput(a.dataset.validateType,a,t);(i||e)&&this._renderMessage(s,a,t)}_fullValidate(t){let e=!0;return t.forEach((t=>{const a=t.querySelector("input")||t.querySelector("select")||t.querySelector("textarea");this.validateFormElement(a,!0),t.classList.contains("is-invalid")&&(e=!1)})),e}validateForm(t){"submit"===t.type&&(this._submitEvent=!0);const e=t.target.querySelectorAll("[data-validate-type]"),a=this._fullValidate(e);return this._createStates(t.target),a}_reset(){this._submitEvent=!1}_validateFormParent(t){const e=t.closest("[data-form-validate]");e.dataset.parentValidate&&this._validateParent(e,e.dataset.parentValidate)}}