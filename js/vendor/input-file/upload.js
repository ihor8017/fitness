import{createElement,renderElement}from"./render.js";import{createPreviewContainerMarkup}from"./create-preview-container-markup.js";import{createMessageMarkup}from"./create-message-markup.js";import{createPreviewMarkup}from"./create-preview-markup.js";export class Upload{constructor(e,s={}){this._uploadBlock=e,this._uploadBlock&&(this._options=s,this._formParent=this._uploadBlock.closest("form"),this._maxFileSize=!!this._options.maxFileSize&&this._options.maxFileSize,this._maxFullSize=!!this._options.maxFullSize&&this._options.maxFullSize,this._dropZone=!!this._options.dropZone&&this._options.dropZone,this._renderPreview=!!this._options.preview&&this._options.preview,this._uploadLength=this._options.uploadLength?this._options.uploadLength:1,this._accept=!!this._options.accept&&this._options.accept,this._emptyMessage=!!this._options.emptyMessage&&this._options.emptyMessage,this._errorMessage=!!this._options.errorMessage&&this._options.errorMessage,this._successMessage=!!this._options.successMessage&&this._options.successMessage,this._input=this._uploadBlock.querySelector("input"),this._dropZoneBlock=!!this._dropZone&&this._uploadBlock.querySelector("[data-drop-zone]"),this._previewBlock=null,this._files=[],this._message=null,this._onDropZoneBlockDragover=this._onDropZoneBlockDragover.bind(this),this._onDropZoneBlockDragenter=this._onDropZoneBlockDragenter.bind(this),this._onDropZoneBlockDragleave=this._onDropZoneBlockDragleave.bind(this),this._onDropZoneBlockDrop=this._onDropZoneBlockDrop.bind(this),this._onDropZoneBlockClick=this._onDropZoneBlockClick.bind(this),this._onInputChange=this._onInputChange.bind(this),this._onPreviewBlockClick=this._onPreviewBlockClick.bind(this),this._onFormParentReset=this._onFormParentReset.bind(this),this._onFormParentSubmit=this._onFormParentSubmit.bind(this),this._init())}_overwriteFileList(){const e=new DataTransfer;this._files.forEach((s=>e.items.add(s))),this._input.files=e.files}_changeDropZoneBlock(){this._files.length?this._dropZoneBlock.classList.add("not-empty"):this._dropZoneBlock.classList.remove("not-empty")}_checkAccept(e){let s=!1;return this._accept.forEach((t=>{e.name.endsWith(t)&&(s=!0)})),s}_renderMessage(e){this._message&&this._message.remove(),this._message=createElement(createMessageMarkup(e)),renderElement(this._uploadBlock,this._message)}_renderFiles(){let e=!1;this._accept&&(this._files=this._files.filter((e=>this._checkAccept(e)))),this._overwriteFileList(),e=!!this._maxFullSize&&this._checkFullSize(this._files)>this._maxFullSize,this._previewBlock&&(this._previewBlock.innerHTML=""),this._dropZoneBlock&&this._changeDropZoneBlock(),this._files.forEach((s=>{const t=!!this._maxFileSize&&s.size>this._maxFileSize;t&&(e=!0);const i=new FileReader;this._previewBlock&&i.addEventListener("load",(e=>{renderElement(this._previewBlock,createElement(createPreviewMarkup(s,e,this._options,t)))})),i.readAsDataURL(s)})),e?(this._uploadBlock.classList.add("is-invalid"),this._errorMessage&&this._renderMessage(this._errorMessage)):(this._uploadBlock.classList.remove("is-invalid"),this._message&&(this._message.remove(),this._message=null))}_checkFullSize(e){let s=0;return e.forEach((e=>{s+=e.size})),s}reset(){this._uploadBlock.classList.remove("is-invalid"),this._uploadBlock.classList.remove("is-valid"),this._dropZoneBlock&&this._dropZoneBlock.classList.remove("not-empty"),this._uploadBlock.querySelectorAll(".is-invalid").forEach((e=>e.classList.remove("is-invalid"))),this._uploadBlock.querySelectorAll(".is-valid").forEach((e=>e.classList.remove("is-valid"))),this._files=[],this._previewBlock&&(this._previewBlock.innerHTML=""),this._message&&(this._message.remove(),this._message=null)}_onFormParentReset(){this.reset()}_onFormParentSubmit(){!this._files.length&&this._emptyMessage&&this._renderMessage(this._emptyMessage)}_onPreviewBlockClick(e){if(!e.target.dataset.fileName)return;const s=e.target.dataset.fileName;this._files=this._files.filter((e=>e.name!==s)),this._overwriteFileList(),this._previewBlock.querySelector(`[data-file-name="${s}"]`).parentElement.remove(),this._dropZoneBlock&&this._changeDropZoneBlock();!!this._maxFullSize&&this._checkFullSize(this._files)>this._maxFullSize?(this._uploadBlock.classList.add("is-invalid"),this._errorMessage&&this._renderMessage(this._errorMessage)):(this._uploadBlock.classList.remove("is-invalid"),this._message&&(this._message.remove(),this._message=null))}_onDropZoneBlockClick(e){e.target.dataset.fileName||e.target.closest(".input-upload__preview")||this._input.click()}_onDropZoneBlockDragover(e){e.preventDefault(),this._dropZoneBlock.classList.contains("is-drag")||this._dropZoneBlock.classList.add("is-drag")}_onDropZoneBlockDragenter(e){e.preventDefault(),this._dropZoneBlock.classList.contains("is-drag")&&this._dropZoneBlock.classList.remove("is-drag")}_onDropZoneBlockDragleave(e){e.preventDefault(),this._dropZoneBlock.classList.contains("is-drag")&&this._dropZoneBlock.classList.remove("is-drag")}_onDropZoneBlockDrop(e){e.preventDefault(),this._dropZoneBlock.classList.remove("is-drag"),e.dataTransfer.files.length&&(this._files=[...this._files,...e.dataTransfer.files].slice(0,this._uploadLength),this._renderFiles())}_onInputChange(e){e.target.files.length&&(this._files=[...this._files,...e.target.files].slice(0,this._uploadLength),this._renderFiles())}_init(){this._input.addEventListener("change",this._onInputChange),this._uploadLength>1&&this._input.setAttribute("multiple",""),this._accept&&this._input.setAttribute("accept",this._accept),this._dropZoneBlock&&(this._previewBlock=createElement(createPreviewContainerMarkup(this._options)),this._previewBlock.addEventListener("click",this._onPreviewBlockClick),this._dropZoneBlock.addEventListener("dragover",this._onDropZoneBlockDragover),this._dropZoneBlock.addEventListener("dragenter",this._onDropZoneBlockDragenter),this._dropZoneBlock.addEventListener("dragleave",this._onDropZoneBlockDragleave),this._dropZoneBlock.addEventListener("drop",this._onDropZoneBlockDrop),this._dropZoneBlock.addEventListener("click",this._onDropZoneBlockClick),renderElement(this._dropZoneBlock,this._previewBlock)),this._renderPreview&&(this._previewBlock=createElement(createPreviewContainerMarkup(this._options)),this._previewBlock.addEventListener("click",this._onPreviewBlockClick),renderElement(this._uploadBlock,this._previewBlock)),this._formParent&&(this._formParent.addEventListener("reset",this._onFormParentReset),this._formParent.addEventListener("submit",this._onFormParentSubmit))}}